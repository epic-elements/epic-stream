<link rel="import"
	href="../../polymer/polymer.html">
<link rel="import"
	href="xstream.html">
<script>
	/**
	 * Creates an observable stream from Polymer lifecycle callbacks
	 *
	 * @polymerBehavior Epic.StreamFromPropertiesBehavior
	 */
	Polymer.Epic = Polymer.Epic || {};
	Polymer.Epic.StreamFromPropertiesBehavior = {
		_createStreamFromProperies: function(el) {
			let props$ = xs
				.of(el.properties)
				.map(props => xs.fromArray(Object.keys(props)))
				.compose(xs.flattenConcurrently)
			let propEvents$ = props$
				.map(prop => xs
					.fromEvent(el, `${el._camel2dashed(prop)}-changed`)
					.map(event => ({
						[prop]: event.detail.value
					})))
				.compose(xs.flattenConcurrently);
			let propValues$ = props$
				.map(key => Object.assign({}, {
					[key]: el[key]
				}));
			// return propValues$;
			return xs.merge(propValues$, propEvents$)
		},
		// _createStreamFromProperties: function(el) {
		// 	try {
		// 		return Rx.Observable
		// 			.of(el)
		// 			.filter(el => el)
		// 			.map(el => el.properties)
		// 			.filter(p => p)
		// 			.filter(p => typeof p === 'object')
		// 			.filter(p => Object.keys(p).length !== 0)
		// 			.mergeMap(p => Rx.Observable.from(Object.keys(p)))
		// 			.map(k => Rx.Observable
		// 				.fromEvent(
		// 					el,
		// 					`${el._camel2dashed(k)}-changed`,
		// 					e => Object.keys(el.properties)))
		// 			.mergeAll()
		// 			.switchMap(array => Rx.Observable
		// 				.from(array)
		// 				.map(key => Object.assign({}, {
		// 					[key]: el[key]
		// 				})))




		// .switchMap(k => Rx.Observable
		// 	.fromEvent(
		// 		element,
		// 		`${element._camel2dashed(k)}-changed`,
		// 		(e) => element.properties));

		// var propValues$ = props$
		// 	.map(k => Object.assign({}, {
		// 		[k]: element[k]
		// 	}));
		// var propChangedEvents$ = props$
		// 	.do(e => console.log(e))
		// 	.switchMap(p => {
		// 		console.log(p);
		// 		return Rx.Observable
		// 			.fromEvent(element, `${p.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase()}-changed`)
		// 			.do(e => console.log(e))
		// 	})
		// 	.do(e => console.log(e))
		// 	// console.log(element);
		// return propChangedEvents$;
		// 	} catch (e) {
		// 		console.log(e);
		// 		return Rx.Observable.throw(e);
		// 	}
		// },
		// _createStreamFromPropertyChanges: function(property) {
		// 	let currentProperty$ = Rx.Observable
		// 		.of(this[property]);
		// 	let lpropertyChangeEvent$ = Rx.Observable
		// 		.fromEvent(this, `${this._camel2dashed(property)}-changed`)
		// 		.map(e => e.detail.value);
		// 	return Rx.Observable
		// 		.merge(currentProperty$, lpropertyChangeEvent$)
		// 		.distinctUntilChanged();
		// },


		// properties: {
		// 	_properties$: {
		// 		type: Object,
		// 		value: function() {
		// 			let properties$ = new Rx.ReplaySubject();
		// 			return properties$.mergeAll();
		// 		},
		// 		notify: false,
		// 		readOnly: true
		// 	}
		// },
		// beforeRegister: function() {
		// 
		// 
		// 
		// 	let properties$ = this._createStreamFromPropertyModel(this.properties);
		// 	let observers$ = this._createObserversStream(properties$);
		// 	this._handleCallBacksEffects(properties$, observers$);
		// },
		// _createStreamFromPropertyModel: function() {
		// 	const props$ = this._createStreamFromProperies(this);
		// 	const currentPropValues$ = props$
		// 		.compose(this
		// 			._currentPropValues
		// 			.bind(this));
		// 	const propChangedEvents$ = props$
		// 		.compose(this._propEvents.bind(this))
		// 	return xs.me +rge(currentPropValues$, propChangedEvents$);
		// },
		//,
		// _currentPropValues: function(source$) {
		// 	return source$
		// 		.map(prop => Object.assign({}, {
		// 			[prop]: this[prop]
		// 		}));
		// },
		// _propEvents: function(source$) {
		// 	return source$
		// 		.map(prop => xs
		// 			.fromEvent(this, `${this._camel2dashed(prop)}-changed`)
		// 			.map(event => ({
		// 				[prop]: event.detail.value
		// 			})))
		// 		.compose(xs.flattenConcurrently);
		// },
		_camel2dashed: function(text) {
			return text.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
		}
	};
</script>
